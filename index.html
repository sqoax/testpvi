<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVI Analyzer Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #050509;
            --surface: #0c0c12;
            --surface-light: #1a1a24;
            --accent: #39ff88;
            --text: #ffffff;
            --text-muted: #888b99;
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Fixed layout */
            display: flex;
        }

        /* --- SIDEBAR / LIST VIEW --- */
        .sidebar {
            width: 400px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--surface);
            z-index: 2;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            width: 100%;
            background: var(--surface-light);
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            outline: none;
            margin-top: 12px;
        }
        .search-box:focus { border-color: var(--accent); }

        .player-list {
            overflow-y: auto;
            flex: 1;
        }

        .player-card {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-card:hover { background: var(--surface-light); }
        .player-card.active { background: rgba(57, 255, 136, 0.05); border-left: 3px solid var(--accent); }

        .p-name { font-weight: 600; display: block; font-size: 15px; }
        .p-stats { font-size: 12px; color: var(--text-muted); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }
        .p-score { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent); font-size: 16px; }

        /* --- MAIN CONTENT / DETAIL VIEW --- */
        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: radial-gradient(circle at top right, #13131f 0%, #050509 60%);
        }

        /* EMPTY STATE */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: var(--text-muted);
        }
        .loader {
            width: 24px; height: 24px; border: 3px solid var(--accent); 
            border-bottom-color: transparent; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* DASHBOARD GRID */
        .dashboard {
            padding: 40px;
            display: none; /* Hidden until selected */
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        .dashboard.visible { display: block; }

        .header-flex {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 32px; border-bottom: 1px solid var(--border); padding-bottom: 20px;
        }
        .player-title h1 { font-size: 32px; margin-bottom: 8px; }
        .badge { 
            padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 600; 
            background: rgba(255,255,255,0.1); color: var(--text-muted);
        }

        /* CHARTS ROW */
        .stats-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px;
            margin-bottom: 32px;
        }
        .card {
            background: rgba(12, 12, 18, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px; padding: 24px;
        }
        .card h3 { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }

        /* TABLE ROW */
        .history-table {
            width: 100%; border-collapse: collapse; font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }
        .history-table th { text-align: left; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); }
        .history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .val-pos { color: var(--accent); }
        .val-neg { color: #ff4444; }

        /* RESPONSIVE */
        @media (max-width: 800px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: 300px; border-right: none; border-bottom: 1px solid var(--border); }
            .stats-grid { grid-template-columns: 1fr; }
            .main-view { overflow: visible; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 18px;">PVI Analyzer</h2>
            <input type="text" id="search" class="search-box" placeholder="Search players..." onkeyup="filterPlayers()">
            <div id="status-msg" style="font-size:11px; color:var(--text-muted); margin-top:8px;">Connecting to Repo...</div>
        </div>
        <div class="player-list" id="player-list-container">
            </div>
    </div>

    <div class="main-view">
        
        <div id="empty-state" class="empty-state">
            <div class="loader" id="loading-spinner"></div>
            <p id="loading-text">Fetching pvi_tourneys.xlsx...</p>
            <p style="font-size:12px; margin-top:8px; opacity:0.5;">Select a player to view analysis</p>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="header-flex">
                <div class="player-title">
                    <span class="badge">PGA TOUR</span>
                    <h1 id="d-name">Player Name</h1>
                    <div style="font-family:'JetBrains Mono'; color:var(--text-muted); font-size:14px;">
                        Events Tracked: <span id="d-events" style="color:white">0</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px; color:var(--text-muted);">AVG PVI</div>
                    <div id="d-pvi" style="font-size:32px; color:var(--accent); font-family:'JetBrains Mono'; font-weight:700;">0.00</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <h3>PVI Performance History</h3>
                    <div style="height: 250px;">
                        <canvas id="pviChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3>SG Breakdown (Avg)</h3>
                    <div style="height: 250px;">
                        <canvas id="sgChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Tournament Log</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Tournament</th>
                            <th>Finish</th>
                            <th>SG:TOT</th>
                            <th>PVI</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // --- GLOBAL STATE ---
    let rawData = [];
    let playersData = {}; // { "Scottie Scheffler": { stats, history: [] } }
    let pviChartInstance = null;
    let sgChartInstance = null;

    // --- INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchExcel();
    });

    // 1. FETCH DATA FROM REPO
    async function fetchExcel() {
        try {
            // Tries to find the file in the current directory (GitHub Repo Root)
            const response = await fetch('./pvi_tourneys.xlsx');
            
            if (!response.ok) throw new Error("File not found. Ensure 'pvi_tourneys.xlsx' is in repo.");

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to JSON
            rawData = XLSX.utils.sheet_to_json(worksheet);
            
            processData(rawData);
            
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('loading-text').innerText = "Database Loaded. Select a player.";
            document.getElementById('status-msg').innerText = `${rawData.length} Records Loaded`;
            document.getElementById('status-msg').style.color = "var(--accent)";

        } catch (err) {
            console.error(err);
            document.getElementById('loading-text').innerText = "Error loading data.";
            document.getElementById('status-msg').innerText = "Failed to load pvi_tourneys.xlsx";
            document.getElementById('status-msg').style.color = "#ff4444";
        }
    }

    // 2. PROCESS DATA (GROUP BY PLAYER)
    function processData(data) {
        playersData = {};

        data.forEach(row => {
            const pName = row['Player'];
            if (!pName) return;

            if (!playersData[pName]) {
                playersData[pName] = {
                    name: pName,
                    history: [],
                    totalPVI: 0,
                    totalSG: 0,
                    count: 0,
                    // SG Sums for averages
                    sg: { ott: 0, app: 0, arg: 0, putt: 0 }
                };
            }

            // Safe Float Parsing
            const pvi = parseFloat(row['PVI']) || 0;
            const sgTot = parseFloat(row['SG:TOT']) || 0;
            const sgOtt = parseFloat(row['SG:OTT']) || 0;
            const sgApp = parseFloat(row['SG:APP']) || 0;
            const sgArg = parseFloat(row['SG:ARG']) || 0;
            const sgPutt = parseFloat(row['SG:PUTT']) || 0;

            playersData[pName].history.push({
                tournament: row['Tournament'],
                finish: row['Finish'],
                pvi: pvi,
                sgTot: sgTot,
                rawRow: row
            });

            playersData[pName].totalPVI += pvi;
            playersData[pName].totalSG += sgTot;
            playersData[pName].sg.ott += sgOtt;
            playersData[pName].sg.app += sgApp;
            playersData[pName].sg.arg += sgArg;
            playersData[pName].sg.putt += sgPutt;
            playersData[pName].count++;
        });

        // Calculate Averages
        Object.keys(playersData).forEach(key => {
            const p = playersData[key];
            p.avgPVI = p.totalPVI / p.count;
            p.avgSG = p.totalSG / p.count;
            p.avgSgBreakdown = [
                p.sg.ott / p.count,
                p.sg.app / p.count,
                p.sg.arg / p.count,
                p.sg.putt / p.count
            ];
        });

        renderPlayerList(Object.values(playersData));
    }

    // 3. RENDER SIDEBAR LIST
    function renderPlayerList(players) {
        const container = document.getElementById('player-list-container');
        container.innerHTML = "";

        // Sort by PVI descending
        players.sort((a, b) => b.avgPVI - a.avgPVI);

        players.forEach(p => {
            const el = document.createElement('div');
            el.className = 'player-card';
            el.onclick = () => loadPlayerDashboard(p.name, el);
            el.innerHTML = `
                <div>
                    <span class="p-name">${p.name}</span>
                    <span class="p-stats">Events: ${p.count} â€¢ SG: ${p.avgSG.toFixed(2)}</span>
                </div>
                <div class="p-score">${p.avgPVI.toFixed(2)}</div>
            `;
            // Add data-name for search
            el.dataset.name = p.name.toLowerCase();
            container.appendChild(el);
        });
    }

    // 4. SEARCH FILTER
    function filterPlayers() {
        const term = document.getElementById('search').value.toLowerCase();
        const cards = document.querySelectorAll('.player-card');
        cards.forEach(card => {
            if (card.dataset.name.includes(term)) {
                card.style.display = "flex";
            } else {
                card.style.display = "none";
            }
        });
    }

    // 5. LOAD DASHBOARD (THE CLICK EVENT)
    function loadPlayerDashboard(name, cardElement) {
        // UI Updates
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('dashboard').classList.add('visible');
        
        // Highlight Active Card
        document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
        if(cardElement) cardElement.classList.add('active');

        const p = playersData[name];

        // Fill Header
        document.getElementById('d-name').innerText = p.name;
        document.getElementById('d-events').innerText = p.count;
        const pviDisplay = document.getElementById('d-pvi');
        pviDisplay.innerText = p.avgPVI.toFixed(2);
        pviDisplay.style.color = p.avgPVI >= 1.0 ? "var(--accent)" : "#ff4444";

        // Fill Table
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = "";
        // Show last 10 events
        const recentHistory = p.history.slice().reverse(); // Copy and reverse for newest first
        
        recentHistory.forEach(h => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${h.tournament}</td>
                <td>${h.finish || '-'}</td>
                <td class="${h.sgTot >= 0 ? 'val-pos' : 'val-neg'}">${h.sgTot.toFixed(2)}</td>
                <td><span style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${h.pvi.toFixed(2)}</span></td>
            `;
            tbody.appendChild(tr);
        });

        // RENDER CHARTS
        renderCharts(p);
    }

    function renderCharts(player) {
        // DESTROY OLD CHARTS
        if (pviChartInstance) pviChartInstance.destroy();
        if (sgChartInstance) sgChartInstance.destroy();

        // CHART 1: PVI HISTORY (Line)
        const ctx1 = document.getElementById('pviChart').getContext('2d');
        
        // Prepare labels (Tournaments) and data (PVI)
        // We want chronological order for the chart
        const chartHistory = player.history; // Already chronological from ProcessData usually
        const labels = chartHistory.map(h => {
            // Shorten name: "The Sentry" -> "Sentry"
            return h.tournament.replace("The ", "").substring(0, 10);
        });
        const dataPvi = chartHistory.map(h => h.pvi);

        pviChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'PVI',
                    data: dataPvi,
                    borderColor: '#39ff88',
                    backgroundColor: 'rgba(57, 255, 136, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#000',
                    pointBorderColor: '#39ff88'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#888b99' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#888b99', maxTicksLimit: 5 }
                    }
                }
            }
        });

        // CHART 2: SG BREAKDOWN (Bar)
        const ctx2 = document.getElementById('sgChart').getContext('2d');
        sgChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['OTT', 'APP', 'ARG', 'PUTT'],
                datasets: [{
                    label: 'Average SG',
                    data: player.avgSgBreakdown,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)', // OTT Blue
                        'rgba(75, 192, 192, 0.6)', // APP Teal
                        'rgba(255, 206, 86, 0.6)', // ARG Yellow
                        'rgba(255, 99, 132, 0.6)'  // PUTT Red
                    ],
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#888b99' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#888b99' }
                    }
                }
            }
        });
    }

</script>
</body>
</html>
