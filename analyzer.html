<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PVI Analyzer · Pro Terminal</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            dark: {
              900: '#050507',
              800: '#0E0E12',
              700: '#1A1A24',
              border: 'rgba(255,255,255,0.08)'
            },
            accent: {
              green: '#39FF88',
              blue: '#39DFFF',
              purple: '#9F39FF'
            }
          },
          backgroundImage: {
            'grid-pattern': "linear-gradient(to right, #1f2937 1px, transparent 1px), linear-gradient(to bottom, #1f2937 1px, transparent 1px)",
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #050507; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Animations */
    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fade-in-up 0.4s ease-out forwards; }
    
    .glass-panel {
      background: rgba(14, 14, 18, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    /* Table Styling */
    .data-row:hover td { background: rgba(255,255,255,0.03); color: white; }
    th { position: sticky; top: 0; background: #0E0E12; z-index: 10; }
  </style>
</head>

<body class="h-full bg-dark-900 text-slate-200 antialiased selection:bg-accent-green/30 selection:text-accent-green">
  
  <div class="fixed inset-0 z-0 opacity-[0.03] pointer-events-none" style="background-image: linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px); background-size: 40px 40px;"></div>

  <div class="relative z-10 flex flex-col min-h-screen">
    
    <header class="border-b border-dark-border bg-dark-900/80 backdrop-blur-md sticky top-0 z-50">
      <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 bg-gradient-to-br from-white to-slate-400 rounded flex items-center justify-center text-black font-bold font-mono text-lg">P</div>
          <div>
            <h1 class="text-sm font-semibold text-white tracking-tight">PVI Analyzer <span class="text-xs text-slate-500 font-mono ml-1">PRO.v1.5</span></h1>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
           <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-dark-800 border border-dark-border text-[10px] font-mono text-slate-400">
             <span id="datasetStatusDot" class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
             <span id="datasetStatusLabel">DISCONNECTED</span>
           </div>
           <a href="index.html" class="text-xs font-mono text-slate-500 hover:text-white transition-colors">EXIT TO MENU</a>
        </div>
      </div>
    </header>

    <main class="flex-1 px-4 sm:px-6 lg:px-8 py-8 mx-auto max-w-7xl w-full space-y-6">
      
      <div class="flex flex-col sm:flex-row justify-between items-end gap-4 animate-in" style="animation-delay: 0ms;">
        <div>
            <h2 class="text-2xl font-semibold text-white">Performance Index</h2>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Search Input -->
            <div class="relative group">
                <input type="text" id="searchInput" placeholder="Search Player..." class="bg-dark-800 border border-dark-border hover:border-slate-600 text-xs text-slate-200 rounded-md pl-3 pr-8 py-2 outline-none focus:ring-1 focus:ring-accent-green font-mono transition-colors w-40 sm:w-56">
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>

            <!-- Min Events Input (NEW) -->
            <div class="relative group">
                <input type="number" id="minEventsInput" placeholder="Min Events" min="1" class="appearance-none bg-dark-800 border border-dark-border hover:border-slate-600 text-xs text-slate-200 rounded-md pl-3 pr-2 py-2 outline-none focus:ring-1 focus:ring-accent-green font-mono transition-colors w-24">
            </div>

            <!-- Sort Dropdown -->
            <div class="relative group">
                <select id="sortSelect" class="appearance-none bg-dark-800 border border-dark-border hover:border-slate-600 text-xs text-slate-200 rounded-md pl-3 pr-8 py-2 outline-none focus:ring-1 focus:ring-accent-green cursor-pointer font-mono transition-colors">
                    <option value="totalPvi">Total Value (PVI)</option>
                    <option value="avgPvi">Quality (Avg)</option>
                    <option value="consistencyIndex">Consistency (CI)</option>
                    <option value="volatility">Volatility</option>
                    <option value="trendMomentum">Momentum (3mo)</option>
                    <option value="events">Experience</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
            
            <button id="recalcBtn" disabled class="bg-white text-black hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed px-4 py-2 rounded-md text-xs font-semibold transition-all active:scale-95 flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                REFRESH
            </button>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 animate-in" style="animation-delay: 100ms;">
        
        <div class="glass-panel p-4 rounded-xl">
           <div class="text-[10px] uppercase tracking-wider text-slate-500 font-mono mb-1">Players Tracked</div>
           <div class="text-2xl font-mono font-bold text-white" id="summaryPlayers">-</div>
           <div class="text-[10px] text-slate-500">Unique Entries</div>
        </div>

        <div class="glass-panel p-4 rounded-xl">
           <div class="text-[10px] uppercase tracking-wider text-slate-500 font-mono mb-1">Tournaments</div>
           <div class="text-2xl font-mono font-bold text-white" id="summaryEvents">-</div>
           <div class="text-[10px] text-slate-500">Total Events Logged</div>
        </div>

        <div class="glass-panel p-4 rounded-xl border-l-2 border-l-accent-green">
           <div class="text-[10px] uppercase tracking-wider text-slate-500 font-mono mb-1">Top Earner</div>
           <div class="text-lg font-semibold text-white truncate" id="summaryTopPlayer">-</div>
           <div class="text-[10px] text-accent-green font-mono" id="summaryTopPvi">-</div>
        </div>

        <div class="glass-panel p-4 rounded-xl border-l-2 border-l-accent-blue">
           <div class="text-[10px] uppercase tracking-wider text-slate-500 font-mono mb-1">Most Consistent</div>
           <div class="text-lg font-semibold text-white truncate" id="summaryConsistentPlayer">-</div>
           <div class="text-[10px] text-accent-blue font-mono" id="summaryConsistentMetric">-</div>
        </div>

      </div>

      <div class="glass-panel rounded-xl overflow-hidden animate-in" style="animation-delay: 200ms;">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-[10px] uppercase tracking-wider text-slate-500 font-mono border-b border-dark-border">
                <th class="px-6 py-4 font-medium">Player</th>
                <th class="px-4 py-4 font-medium text-right">Events</th>
                <th class="px-4 py-4 font-medium text-right">Total PVI</th>
                <th class="px-4 py-4 font-medium text-right">Avg PVI</th>
                <th class="px-4 py-4 font-medium text-right">Volatility</th>
                <th class="px-4 py-4 font-medium text-right">Consistency</th>
                <th class="px-4 py-4 font-medium text-right">Momentum</th>
                <th class="px-4 py-4 font-medium text-right">Hits (>1.0)</th>
              </tr>
            </thead>
            <tbody id="playersBody" class="text-sm text-slate-300 font-mono divide-y divide-dark-border/50">
               <tr>
                   <td colspan="8" class="px-6 py-12 text-center text-slate-600 text-xs">
                       Waiting for /pvi_tourneys.xlsx connection...
                   </td>
               </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-xs text-slate-500 animate-in" style="animation-delay: 300ms;">
         <div class="glass-panel p-4 rounded-lg">
            <h3 class="text-white font-semibold mb-2">Reading the Data</h3>
            <ul class="space-y-1">
                <li><span class="text-accent-green">Total PVI:</span> Raw value generated. High number = Money maker.</li>
                <li><span class="text-accent-blue">Avg PVI:</span> Quality per start. >1.0 means beating implied odds.</li>
                <li><span class="text-slate-300">Consistency (CI):</span> Reliability. High CI means steady returns.</li>
            </ul>
         </div>
         <div class="glass-panel p-4 rounded-lg flex flex-col justify-between">
             <div class="flex items-center justify-between mb-2">
                 <span class="text-white font-semibold">System Connection</span>
                 <span class="font-mono" id="datasetSubStatus">Initializing...</span>
             </div>
             <div class="font-mono text-[10px]" id="datasetMeta">--</div>
             
             <input id="fileInput" type="file" accept=".xlsx" class="hidden" />
         </div>
      </div>

    </main>
  </div>

  <div id="playerModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

    <div class="fixed inset-0 overflow-hidden">
      <div class="absolute inset-0 overflow-hidden">
        <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
          
          <div class="pointer-events-auto w-screen max-w-md transform transition-transform translate-x-full" id="modalPanel">
            <div class="flex h-full flex-col overflow-y-scroll bg-dark-900 border-l border-dark-border shadow-2xl">
              
              <div class="px-6 py-6 border-b border-dark-border bg-dark-800">
                <div class="flex items-start justify-between">
                  <div>
                      <h2 class="text-xl font-bold text-white" id="modalPlayerName">Player Name</h2>
                      <p class="text-sm text-slate-400 mt-1 font-mono" id="modalEventsCount">0 Events</p>
                  </div>
                  <button id="modalCloseBtn" type="button" class="rounded-md text-slate-400 hover:text-white focus:outline-none">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <div class="bg-dark-900 p-3 rounded border border-dark-border">
                        <div class="text-[10px] text-slate-500 uppercase">Avg PVI</div>
                        <div class="text-lg font-mono text-accent-green" id="modalAvgPvi">-</div>
                    </div>
                    <div class="bg-dark-900 p-3 rounded border border-dark-border">
                        <div class="text-[10px] text-slate-500 uppercase">Volatility</div>
                        <div class="text-lg font-mono text-white" id="modalVolatility">-</div>
                    </div>
                    <div class="bg-dark-900 p-3 rounded border border-dark-border">
                        <div class="text-[10px] text-slate-500 uppercase">Consistency</div>
                        <div class="text-lg font-mono text-accent-blue" id="modalConsistency">-</div>
                    </div>
                    <div class="bg-dark-900 p-3 rounded border border-dark-border">
                        <div class="text-[10px] text-slate-500 uppercase">Momentum</div>
                        <div class="text-lg font-mono text-white" id="modalTrend">-</div>
                    </div>
                </div>
              </div>

              <div class="relative flex-1 px-6 py-6">
                 <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">Event History</h3>
                 <table class="w-full text-left border-collapse">
                     <thead>
                         <tr class="text-[10px] text-slate-500 uppercase border-b border-dark-border">
                             <th class="pb-2 font-normal">Tournament</th>
                             <th class="pb-2 font-normal text-right">PVI Score</th>
                         </tr>
                     </thead>
                     <tbody id="modalEventsBody" class="text-sm font-mono text-slate-300 divide-y divide-dark-border/30">
                         </tbody>
                 </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Utility helpers ---
    function mean(arr) {
      if (!arr.length) return 0;
      const sum = arr.reduce((a, b) => a + b, 0);
      return sum / arr.length;
    }

    function stddev(arr) {
      if (arr.length < 2) return 0;
      const m = mean(arr);
      const variance = mean(arr.map(x => (x - m) ** 2));
      return Math.sqrt(variance);
    }

    function formatNumber(val, decimals = 2) {
      if (val === null || val === undefined || isNaN(val)) return '–';
      return val.toFixed(decimals);
    }

    // DOM Elements
    const datasetStatusDot = document.getElementById('datasetStatusDot');
    const datasetStatusLabel = document.getElementById('datasetStatusLabel');
    const datasetSubStatus = document.getElementById('datasetSubStatus');
    const datasetMeta = document.getElementById('datasetMeta');
    const recalcBtn = document.getElementById('recalcBtn');
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const minEventsInput = document.getElementById('minEventsInput'); // NEW
    
    // Summary Elements
    const summaryPlayers = document.getElementById('summaryPlayers');
    const summaryEvents = document.getElementById('summaryEvents');
    const summaryQuality = document.getElementById('summaryQuality');
    const summaryQualityHint = document.getElementById('summaryQualityHint');
    const summaryTopPlayer = document.getElementById('summaryTopPlayer');
    const summaryTopPvi = document.getElementById('summaryTopPvi');
    const summaryConsistentPlayer = document.getElementById('summaryConsistentPlayer');
    const summaryConsistentMetric = document.getElementById('summaryConsistentMetric');

    let currentPlayerStats = null;
    let currentEvents = [];
    let currentSortKey = 'totalPvi';

    // --- STATUS MANAGEMENT ---
    function setStatusLoading(message = 'Loading...') {
      datasetStatusDot.className = 'w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse';
      datasetStatusLabel.textContent = 'CONNECTING';
      datasetStatusLabel.className = 'text-yellow-500 font-bold';
      datasetSubStatus.textContent = message;
      recalcBtn.disabled = true;
      recalcBtn.innerHTML = 'LOADING...';
    }

    function setStatusReady(metaText = '') {
      datasetStatusDot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
      datasetStatusLabel.textContent = 'LIVE';
      datasetStatusLabel.className = 'text-emerald-500 font-bold';
      datasetSubStatus.textContent = 'Data Synced Successfully';
      datasetMeta.textContent = metaText;
      recalcBtn.disabled = false;
      recalcBtn.innerHTML = `<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> REFRESH`;
    }

    function setStatusError(message) {
      datasetStatusDot.className = 'w-1.5 h-1.5 rounded-full bg-red-500';
      datasetStatusLabel.textContent = 'ERROR';
      datasetStatusLabel.className = 'text-red-500 font-bold';
      datasetSubStatus.textContent = message;
      recalcBtn.disabled = false;
      recalcBtn.innerHTML = 'RETRY';
    }

    // --- SUMMARY UPDATES ---
    function updateSummary(playerStats) {
      if (!playerStats || !playerStats.length) return;

      // FIX: Use actual length for total counts
      summaryPlayers.textContent = playerStats.length;
      summaryEvents.textContent = currentEvents.length; 

      // Top Earner
      const top = playerStats.reduce((prev, current) => (prev.totalPvi > current.totalPvi) ? prev : current);
      summaryTopPlayer.textContent = top.name;
      summaryTopPvi.textContent = `${top.totalPvi.toFixed(2)} PVI`;

      // Consistency
      const sortedCons = [...playerStats].filter(p => p.events > 3).sort((a,b) => b.consistencyIndex - a.consistencyIndex);
      if(sortedCons.length > 0) {
          summaryConsistentPlayer.textContent = sortedCons[0].name;
          summaryConsistentMetric.textContent = `${sortedCons[0].consistencyIndex.toFixed(2)} CI`;
      }
    }

    // --- SORTING ---
    function sortStats(stats) {
      return stats.sort((a, b) => {
        switch (currentSortKey) {
          case 'avgPvi': return b.avgPvi - a.avgPvi;
          case 'volatility': return b.volatility - a.volatility;
          case 'consistencyIndex': return b.consistencyIndex - a.consistencyIndex;
          case 'trendMomentum': return b.trendMomentum - a.trendMomentum;
          case 'events': return b.events - a.events;
          default: return b.totalPvi - a.totalPvi;
        }
      });
    }

    // --- RENDER MAIN TABLE ---
    function renderTable() {
      const tbody = document.getElementById('playersBody');
      tbody.innerHTML = '';
      if (!currentPlayerStats) return;

      // 1. Filter (Search + Min Events Logic)
      const query = searchInput.value.toLowerCase();
      const minEvents = parseInt(minEventsInput.value) || 0;

      let displayStats = currentPlayerStats.filter(p => {
          const matchesName = p.name.toLowerCase().includes(query);
          const matchesCount = p.events >= minEvents;
          return matchesName && matchesCount;
      });

      // 2. Sort
      displayStats = sortStats(displayStats);

      displayStats.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'data-row border-b border-dark-border/50 transition-colors cursor-pointer group';
        
        // HTML Construction
        tr.innerHTML = `
            <td class="px-6 py-3 font-medium text-white group-hover:text-accent-green transition-colors">${p.name}</td>
            <td class="px-4 py-3 text-right text-slate-500">${p.events}</td>
            <td class="px-4 py-3 text-right font-bold text-white">${formatNumber(p.totalPvi)}</td>
            <td class="px-4 py-3 text-right ${p.avgPvi > 1 ? 'text-accent-green' : 'text-slate-400'}">${formatNumber(p.avgPvi)}</td>
            <td class="px-4 py-3 text-right text-slate-500">${formatNumber(p.volatility)}</td>
            <td class="px-4 py-3 text-right ${p.consistencyIndex > 1 ? 'text-accent-blue' : 'text-slate-500'}">${formatNumber(p.consistencyIndex)}</td>
            <td class="px-4 py-3 text-right">
                <span class="${p.trendMomentum > 0 ? 'text-accent-green' : 'text-red-400'}">${p.trendMomentum > 0 ? '+' : ''}${formatNumber(p.trendMomentum)}</span>
            </td>
            <td class="px-4 py-3 text-right">
                ${p.countGte1 > 0 ? `<span class="bg-dark-800 border border-dark-border text-white px-2 py-0.5 rounded text-[10px]">${p.countGte1}</span>` : '<span class="text-slate-600">-</span>'}
            </td>
        `;

        tr.addEventListener('click', () => openPlayerModal(p));
        tbody.appendChild(tr);
      });
      
      // Update Summary with FULL stats (not filtered) so header cards don't jump around
      updateSummary(currentPlayerStats);
      setStatusReady(`${currentEvents.length} Events · ${currentPlayerStats.length} Players`);
    }

    // --- MODAL LOGIC ---
    const playerModal = document.getElementById('playerModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalPanel = document.getElementById('modalPanel');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // Content Elements
    const modalPlayerName = document.getElementById('modalPlayerName');
    const modalEventsCount = document.getElementById('modalEventsCount');
    const modalAvgPvi = document.getElementById('modalAvgPvi');
    const modalVolatility = document.getElementById('modalVolatility');
    const modalConsistency = document.getElementById('modalConsistency');
    const modalTrend = document.getElementById('modalTrend');
    const modalEventsBody = document.getElementById('modalEventsBody');

    function openPlayerModal(player) {
        modalPlayerName.textContent = player.name;
        modalEventsCount.textContent = `${player.events} Tournaments Tracked`;
        
        modalAvgPvi.textContent = formatNumber(player.avgPvi);
        modalVolatility.textContent = formatNumber(player.volatility);
        modalConsistency.textContent = formatNumber(player.consistencyIndex);
        modalTrend.textContent = (player.trendMomentum > 0 ? '+' : '') + formatNumber(player.trendMomentum);
        modalTrend.className = `text-lg font-mono ${player.trendMomentum > 0 ? 'text-accent-green' : 'text-red-400'}`;

        // Populate Breakdown
        modalEventsBody.innerHTML = '';
        const sortedEvents = [...player.eventsDetail].sort((a,b) => a.event.localeCompare(b.event));
        
        sortedEvents.forEach(ev => {
            const row = document.createElement('tr');
            row.className = "border-b border-dark-border/30 hover:bg-white/5 transition-colors";
            row.innerHTML = `
                <td class="py-3 text-slate-400">${ev.event}</td>
                <td class="py-3 text-right font-medium ${ev.pvi > 1 ? 'text-accent-green' : 'text-slate-500'}">${formatNumber(ev.pvi)}</td>
            `;
            modalEventsBody.appendChild(row);
        });

        // Show Modal (Animation)
        playerModal.classList.remove('hidden');
        // Small timeout to allow display:block to apply before opacity transition
        setTimeout(() => {
            modalBackdrop.classList.remove('opacity-0');
            modalPanel.classList.remove('translate-x-full');
        }, 10);
    }

    function closePlayerModal() {
        modalBackdrop.classList.add('opacity-0');
        modalPanel.classList.add('translate-x-full');
        setTimeout(() => {
            playerModal.classList.add('hidden');
        }, 300); // Match transition duration
    }

    modalCloseBtn.addEventListener('click', closePlayerModal);
    modalBackdrop.addEventListener('click', closePlayerModal);

    // --- DATA PROCESSING ENGINE ---
    function processSheet(sheet) {
        if (!sheet || !sheet.length) {
            setStatusError('Sheet is empty');
            return;
        }

        const headerRow = sheet[0];
        const dataRows = sheet.slice(1);
        const events = [];
        const eventColumns = [];

        // Map headers
        for (let i = 0; i < headerRow.length; i++) {
            const header = (headerRow[i] || '').toString().trim();
            if (header && header !== 'PVI') {
                const pviColIdx = i + 1;
                if (pviColIdx < headerRow.length && (headerRow[pviColIdx] || '').toString().trim() === 'PVI') {
                    events.push(header);
                    eventColumns.push({ nameCol: i, pviCol: pviColIdx, eventName: header });
                }
            }
        }

        const playerMap = new Map();

        // Parse Rows
        for (const row of dataRows) {
            if (!row) continue;
            for (const evt of eventColumns) {
                const name = (row[evt.nameCol] || '').toString().trim();
                const pviVal = parseFloat(row[evt.pviCol]);
                
                if (!name || isNaN(pviVal)) continue;

                if (!playerMap.has(name)) {
                    playerMap.set(name, { name, pvis: [], eventsDetail: [] });
                }
                const p = playerMap.get(name);
                p.pvis.push(pviVal);
                p.eventsDetail.push({ event: evt.eventName, pvi: pviVal });
            }
        }

        // Calculate Stats
        const players = Array.from(playerMap.values());
        const playerStats = players.map(p => {
            const eventsCount = p.pvis.length;
            const totalPvi = p.pvis.reduce((a, b) => a + b, 0);
            const avgPvi = eventsCount ? totalPvi / eventsCount : 0;
            const volatility = stddev(p.pvis);
            const consistencyIndex = volatility > 0 ? avgPvi / volatility : 0;
            
            // Momentum
            const sortedPvis = [...p.pvis].sort((a,b)=>a-b); 
            const last3 = sortedPvis.slice(-3);
            const prev3 = sortedPvis.slice(-6, -3);
            const last3Avg = last3.length ? mean(last3) : 0;
            const prev3Avg = prev3.length ? mean(prev3) : 0;
            const trendMomentum = last3Avg - prev3Avg;

            const countGte1 = p.pvis.filter(v => v >= 1).length;

            return {
                name: p.name,
                pvis: p.pvis,
                events: eventsCount,
                totalPvi,
                avgPvi,
                volatility,
                consistencyIndex,
                trendMomentum,
                countGte1,
                eventsDetail: p.eventsDetail
            };
        });

        currentEvents = events;
        currentPlayerStats = playerStats;
        renderTable();
    }

    // --- DATA FETCHING ---
    async function loadWorkbookFromRepo() {
        try {
            setStatusLoading('Connecting to GitHub...');
            const res = await fetch('pvi_tourneys.xlsx');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const arrayBuf = await res.arrayBuffer();
            const wb = XLSX.read(arrayBuf, { type: 'array' });
            const sheetName = 'Tourneys';
            const ws = wb.Sheets[sheetName] || wb.Sheets[wb.SheetNames[0]];
            
            if (!ws) {
                setStatusError('Sheet "Tourneys" missing');
                return;
            }
            
            const sheet = XLSX.utils.sheet_to_json(ws, { header: 1 });
            processSheet(sheet);

        } catch (err) {
            console.error(err);
            setStatusError('Failed to load pvi_tourneys.xlsx');
        }
    }

    // --- EVENT LISTENERS ---
    recalcBtn.addEventListener('click', loadWorkbookFromRepo);
    sortSelect.addEventListener('change', (e) => {
        currentSortKey = e.target.value;
        renderTable();
    });
    
    // Search & Min Events Filters
    searchInput.addEventListener('keyup', renderTable);
    minEventsInput.addEventListener('keyup', renderTable);
    minEventsInput.addEventListener('change', renderTable);

    // File Upload Fallback
    document.getElementById('fileInput')?.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        setStatusLoading('Parsing File...');
        const reader = new FileReader();
        reader.onload = event => {
            const data = new Uint8Array(event.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets['Tourneys'] || wb.Sheets[wb.SheetNames[0]];
            const sheet = XLSX.utils.sheet_to_json(ws, { header: 1 });
            processSheet(sheet);
        };
        reader.readAsArrayBuffer(file);
    });

    // Init
    window.addEventListener('load', loadWorkbookFromRepo);

  </script>
</body>
</html>